<launch>

  <let name="urdf_path"
       value="$(find-pkg-share kuka_description)/urdf/kuka_gazebo.xacro" />

  <let name="rviz_path"
       value="$(find-pkg-share kuka_description)/rviz/urdf_config.rviz" />

  <let name="config_path"
       value="$(find-pkg-share kuka_description)/config/kuka_controllers.yaml" />

  <let name="gz_config_path"
       value="$(find-pkg-share kuka_description)/config/gazebo_bridge.yaml" />

  <!-- robot_state_publisher (ONLY place where robot_description is set) -->
  <node pkg="robot_state_publisher"
        exec="robot_state_publisher"
        output="screen">
    <param name="robot_description"
           value="$(command 'xacro $(var urdf_path)')" />
  </node>

  <!-- Gazebo -->
  <include file="$(find-pkg-share ros_gz_sim)/launch/gz_sim.launch.py">
    <arg name="gz_args" value="empty.sdf -r"/>
  </include>

  <!-- Spawn entity -->
  <node pkg="ros_gz_sim"
        exec="create"
        args="-topic robot_description -name kuka"
        output="screen"/>

  <!-- ros2_control_node (NO robot_description parameter!) -->
  <!-- <node pkg="controller_manager"
        exec="ros2_control_node"
        output="screen">
    <param from="$(var config_path)" />
  </node> -->

  <!-- Controllers -->
  <node pkg="controller_manager"
        exec="spawner"
        args="joint_state_broadcaster --controller-manager /controller_manager"/>

  <node pkg="controller_manager"
        exec="spawner"
        args="position_controller --controller-manager /controller_manager"/>

  <!-- Bridge -->
  <node pkg="ros_gz_bridge"
        exec="parameter_bridge"
        output="screen">
    <param name="config_file" value="$(var gz_config_path)"/>
  </node>

  <!-- RViz -->
  <node pkg="rviz2"
        exec="rviz2"
        args="-d $(var rviz_path)"
        output="screen"/>

</launch>
